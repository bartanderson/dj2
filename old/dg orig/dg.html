<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Master AI</title>
    <style>
        /*... CSS styles ... */
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --accent: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: var(--light);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        header {
            text-align: center;
            padding: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            background: linear-gradient(to right, #3498db, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .content {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .controls {
            flex: 1;
            min-width: 280px;
            background: rgba(30, 40, 50, 0.7);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .control-group {
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-group h2 {
            margin-bottom: 10px;
            color: #3498db;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        label {
            min-width: 150px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        input[type="number"], select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
            font-size: 0.9rem;
        }
        
        input[type="range"] {
            width: 100%;
            max-width: 200px;
        }
        
        .visualization {
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .dungeon-display {
            position: relative;
            overflow: auto;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1a1f25;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
        }
        
        canvas {
            max-width: 100%;
        }
        
        .description-panel {
            background: rgba(30, 40, 50, 0.85);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .description-panel h3 {
            margin-bottom: 8px;
            color: #3498db;
        }
        
        .room-description {
            min-height: 60px;
            line-height: 1.5;
            color: #ecf0f1;
            font-size: 0.95rem;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #generateBtn {
            background: linear-gradient(to right, #27ae60, #2ecc71);
        }
        
        #randomizeBtn {
            background: linear-gradient(to right, #e67e22, #f39c12);
        }
        
        #newSeedBtn {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .controls, .visualization {
                width: 100%;
            }
        }

    </style>
    <style>
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 10px 0;
    }

    .stats-grid > div {
        background: rgba(0,0,0,0.2);
        padding: 8px;
        border-radius: 4px;
        text-align: center;
    }
    </style>
    <style>
        /* Add new styles for character system */
        #character-creation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        #character-sheet {
            display: none;
            position: fixed;
            right: 20px;
            top: 20px;
            width: 300px;
            background: rgba(30, 40, 50, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dungeon Master AI</h1>
            <div class="header-controls">
                <button id="togglePanel">‚ò∞ Toggle Controls</button>
                <button id="newSeedBtn">üé≤ New Random Seed</button>
                <button id="create-character-btn">üßô Create Character</button>
            </div>
        </header>
        
        <div class="content">
            <div class="controls">
                <div class="control-group">
                    <h2>‚öôÔ∏è Core Parameters</h2>
                    <div class="control-row">
                        <label for="seed">Seed:</label>
                        <input type="number" id="seed" value="12345">
                    </div>
                    <div class="control-row">
                        <label for="rows">Rows (odd):</label>
                        <input type="number" id="rows" min="5" max="99" step="2" value="39">
                    </div>
                    <div class="control-row">
                        <label for="cols">Columns (odd):</label>
                        <input type="number" id="cols" min="5" max="99" step="2" value="39">
                    </div>
                    <div class="control-row">
                        <label for="cellSize">Cell Size (px):</label>
                        <input type="number" id="cellSize" min="5" max="50" value="18">
                    </div>
                </div>
                
                <div class="control-group">
                    <h2>üè∞ Room Settings</h2>
                    <div class="control-row">
                        <label for="roomMin">Min Room Size:</label>
                        <input type="number" id="roomMin" min="2" max="20" value="3">
                    </div>
                    <div class="control-row">
                        <label for="roomMax">Max Room Size:</label>
                        <input type="number" id="roomMax" min="2" max="20" value="9">
                    </div>
                    <div class="control-row">
                        <label for="roomLayout">Room Layout:</label>
                        <select id="roomLayout">
                            <option value="Packed">Packed</option>
                            <option value="Scattered" selected>Scattered</option>
                        </select>
                    </div>
                </div>
                
                <!-- Corridor Settings -->
                <div class="control-group">
                    <h2>üö™ Corridor Settings</h2>
                    <div class="control-row">
                        <label for="corridorLayout">Corridor Layout:</label>
                        <select id="corridorLayout">
                            <option value="Labyrinth">Labyrinth</option>
                            <option value="Bent" selected>Bent</option>
                            <option value="Straight">Straight</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label for="deadEndRemoval">Dead End Removal (%):</label>
                        <input type="range" id="deadEndRemoval" min="0" max="100" value="50">
                        <span id="deadEndValue" style="min-width: 40px;">50%</span>
                    </div>
                </div>
                
                <!-- Dungeon Layout -->
                <div class="control-group">
                    <h2>üìê Dungeon Layout</h2>
                    <div class="control-row">
                        <label for="dungeonLayout">Layout Type:</label>
                        <select id="dungeonLayout">
                            <option value="None" selected>None</option>
                            <option value="Box">Box</option>
                            <option value="Cross">Cross</option>
                            <option value="Round">Round</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label for="stairs">Stair Count:</label>
                        <input type="number" id="stairs" min="0" max="10" value="2">
                    </div>
                </div>
                
                <div class="buttons">
                    <button id="generateBtn">üéÆ Generate Dungeon</button>
                    <button id="randomizeBtn">‚öôÔ∏è Randomize Parameters</button>
                </div>
            </div>
            
            <div class="visualization">
                <div class="dungeon-display">
                    <canvas id="dungeonCanvas"></canvas>
                </div>
                
                <div class="description-panel">
                    <h3>Room Description</h3>
                    <div id="room-description" class="room-description">
                        Generate a dungeon to see the description...
                    </div>
                </div>
            </div>
        </div>
        <!-- Character Creation Modal -->
        <div id="character-creation">
            <h2>Create Your Character</h2>
            <div class="form-group">
                <label for="char-name">Name:</label>
                <input type="text" id="char-name" placeholder="Character name">
            </div>
            <div class="form-group">
                <label for="char-race">Race:</label>
                <select id="char-race">
                    <option>Human</option>
                    <option>Elf</option>
                    <option>Dwarf</option>
                    <option>Halfling</option>
                    <option>Dragonborn</option>
                    <option>Tiefling</option>
                </select>
            </div>
            <div class="form-group">
                <label for="char-class">Class:</label>
                <select id="char-class">
                    <option>Fighter</option>
                    <option>Wizard</option>
                    <option>Rogue</option>
                    <option>Cleric</option>
                    <option>Ranger</option>
                    <option>Bard</option>
                    <option>Paladin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="char-background">Background:</label>
                <textarea id="char-background" placeholder="Character backstory..." rows="3"></textarea>
            </div>
            <button id="create-char-btn" class="btn">Create Character</button>
        </div>
        
        <!-- Character Sheet -->
        <div id="character-sheet">
            <h3>Character Sheet</h3>
            <div id="char-info">
                <p><strong>Name:</strong> <span id="char-sheet-name"></span></p>
                <p><strong>Race:</strong> <span id="char-sheet-race"></span></p>
                <p><strong>Class:</strong> <span id="char-sheet-class"></span></p>
                <p><strong>HP:</strong> <span id="char-sheet-hp"></span></p>
            </div>
            <div class="stats-grid">
                <div class="stat-box">STR: <span class="stat-value" id="stat-str"></span></div>
                <div class="stat-box">DEX: <span class="stat-value" id="stat-dex"></span></div>
                <div class="stat-box">CON: <span class="stat-value" id="stat-con"></span></div>
                <div class="stat-box">INT: <span class="stat-value" id="stat-int"></span></div>
                <div class="stat-box">WIS: <span class="stat-value" id="stat-wis"></span></div>
                <div class="stat-box">CHA: <span class="stat-value" id="stat-cha"></span></div>
            </div>
            <button id="close-sheet" class="btn">Close</button>
        </div>
    </div>

    <div id="character-creation" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#2c3e50; padding:20px; border-radius:10px; z-index:1000;">
        <h2>Create Your Character</h2>
        <div class="form-group">
            <label>Name:</label>
            <input type="text" id="char-name" placeholder="Character name">
        </div>
        <div class="form-group">
            <label>Race:</label>
            <select id="char-race">
                <option>Human</option>
                <option>Elf</option>
                <option>Dwarf</option>
                <option>Halfling</option>
                <option>Dragonborn</option>
                <option>Tiefling</option>
            </select>
        </div>
        <div class="form-group">
            <label>Class:</label>
            <select id="char-class">
                <option>Fighter</option>
                <option>Wizard</option>
                <option>Rogue</option>
                <option>Cleric</option>
                <option>Ranger</option>
                <option>Bard</option>
            </select>
        </div>
        <div class="form-group">
            <label>Background:</label>
            <textarea id="char-background" placeholder="Character backstory..."></textarea>
        </div>
        <button id="create-char-btn">Create Character</button>
    </div>

    <div id="character-sheet" style="display:none; position:fixed; right:20px; top:20px; width:300px; background:rgba(30,40,50,0.9); padding:15px; border-radius:8px; z-index:100;">
        <h3>Character Sheet</h3>
        <div id="char-info">
            <p><strong>Name:</strong> <span id="char-sheet-name"></span></p>
            <p><strong>Race:</strong> <span id="char-sheet-race"></span></p>
            <p><strong>Class:</strong> <span id="char-sheet-class"></span></p>
            <p><strong>HP:</strong> <span id="char-sheet-hp"></span></p>
        </div>
        <div class="stats-grid">
            <div>STR: <span id="stat-str"></span></div>
            <div>DEX: <span id="stat-dex"></span></div>
            <div>CON: <span id="stat-con"></span></div>
            <div>INT: <span id="stat-int"></span></div>
            <div>WIS: <span id="stat-wis"></span></div>
            <div>CHA: <span id="stat-cha"></span></div>
        </div>
        <h4>Equipment</h4>
        <ul id="char-equipment"></ul>
        <button id="close-sheet">Close</button>
    </div>

    <div id="dungeon-interaction" style="display:none; position:fixed; bottom:20px; left:20px; background:rgba(30,40,50,0.9); padding:15px; border-radius:8px; z-index:100;">
        <h3>Dungeon Interaction</h3>
        <div id="interaction-options">
            <!-- Dynamically populated based on current position -->
        </div>
    </div>
    <script src="dg.js"></script>
        <script>
        // WebSocket connection
        const socket = new WebSocket("ws://localhost:8765");
        let playerId = null;
        let generator = null;

        socket.addEventListener("open", (event) => {
            console.log("Connected to game server");
            // Initialize dungeon after connection
            initDungeon();
        });

        socket.addEventListener("message", (event) => {
            const data = JSON.parse(event.data);
            console.log("Received:", data);
            
            switch(data.type) {
                case "dungeon_initialized":
                    console.log("Dungeon ready");
                    document.getElementById("room-description").textContent = 
                        "Dungeon initialized. Create a character to begin.";
                    break;
                    
                case "character_created":
                    playerId = data.data.id;
                    showCharacterSheet(data.data);
                    document.getElementById("character-creation").style.display = "none";
                    break;
                    
                case "game_update":
                    updateGameState(data.data);
                    break;
                    
                case "error":
                    console.error("Server error:", data.message);
                    alert(`Error: ${data.message}`);
                    break;
            }
        });

        // Initialize game
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize dungeon generator
            generator = new DungeonGenerator();
            
            // Create character button
            document.getElementById("create-character-btn").addEventListener("click", showCharacterCreation);
            
            // Character creation form
            document.getElementById("create-char-btn").addEventListener("click", createCharacter);
            
            // Close character sheet
            document.getElementById("close-sheet").addEventListener("click", () => {
                document.getElementById("character-sheet").style.display = "none";
            });
        });

        function initDungeon() {
            // Initialize dungeon with default size
            socket.send(JSON.stringify({
                type: "init_dungeon",
                rows: 40,
                cols: 40
            }));
        }

        function showCharacterCreation() {
            document.getElementById("character-creation").style.display = "block";
        }

        function createCharacter() {
            const name = document.getElementById("char-name").value;
            const race = document.getElementById("char-race").value;
            const cls = document.getElementById("char-class").value;
            const background = document.getElementById("char-background").value;
            
            if (name) {
                socket.send(JSON.stringify({
                    type: "character_create",
                    data: { name, race, class: cls, background }
                }));
            } else {
                alert("Please enter a character name");
            }
        }

        function showCharacterSheet(character) {
            const sheet = document.getElementById("character-sheet");
            sheet.style.display = "block";
            
            document.getElementById("char-sheet-name").textContent = character.name;
            document.getElementById("char-sheet-race").textContent = character.race;
            document.getElementById("char-sheet-class").textContent = character.class_;
            document.getElementById("char-sheet-hp").textContent = 
                `${character.hit_points} / ${character.max_hp || character._calculate_max_hp()}`;
            
            // Populate stats
            if (character.stats) {
                document.getElementById("stat-str").textContent = character.stats.STR;
                document.getElementById("stat-dex").textContent = character.stats.DEX;
                document.getElementById("stat-con").textContent = character.stats.CON;
                document.getElementById("stat-int").textContent = character.stats.INT;
                document.getElementById("stat-wis").textContent = character.stats.WIS;
                document.getElementById("stat-cha").textContent = character.stats.CHA;
            }
        }

        function updateGameState(data) {
            // Update character positions on map
            if (data.characters && generator) {
                generator.characters = data.characters;
                renderCharacters();
                
                // Update current player if exists
                if (playerId && data.characters[playerId]) {
                    showCharacterSheet(data.characters[playerId]);
                }
            }
            
            // Update room description
            if (data.message) {
                document.getElementById("room-description").textContent = data.message;
            }
        }

        function renderCharacters() {
            const canvas = document.getElementById('dungeonCanvas');
            if (!canvas || !generator) return;
            
            const ctx = canvas.getContext('2d');
            const cellSize = generator.opts.cell_size;
            
            // Redraw the dungeon first
            generator.renderToCanvas(canvas);
            
            // Draw each character
            for (const charId in generator.characters) {
                const char = generator.characters[charId];
                const x = char.position[1] * cellSize;
                const y = char.position[0] * cellSize;
                
                // Character circle
                ctx.beginPath();
                ctx.arc(x + cellSize/2, y + cellSize/2, cellSize/3, 0, Math.PI * 2);
                ctx.fillStyle = char.player_controlled ? '#00FF00' : '#FF0000';
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Character name
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(char.name, x + cellSize/2, y - 5);
            }
        }
    </script>
    <script>
        // Character creation flow
        function showCharacterCreation() {
            document.getElementById('character-creation').style.display = 'block';
        }

        document.getElementById('create-char-btn').addEventListener('click', () => {
            const name = document.getElementById('char-name').value;
            const race = document.getElementById('char-race').value;
            const cls = document.getElementById('char-class').value;
            const background = document.getElementById('char-background').value;
            
            if (name) {
                socket.send(JSON.stringify({
                    type: "character_create",
                    data: { name, race, class: cls, background }
                }));
                document.getElementById('character-creation').style.display = 'none';
            }
        });

        // Character sheet management
        function showCharacterSheet(character) {
            const sheet = document.getElementById('character-sheet');
            sheet.style.display = 'block';
            
            document.getElementById('char-sheet-name').textContent = character.name;
            document.getElementById('char-sheet-race').textContent = character.race;
            document.getElementById('char-sheet-class').textContent = character.class_;
            document.getElementById('char-sheet-hp').textContent = 
                `${character.hit_points}/${character._calculate_max_hp()}`;
            
            // Populate stats
            document.getElementById('stat-str').textContent = character.stats.STR;
            document.getElementById('stat-dex').textContent = character.stats.DEX;
            document.getElementById('stat-con').textContent = character.stats.CON;
            document.getElementById('stat-int').textContent = character.stats.INT;
            document.getElementById('stat-wis').textContent = character.stats.WIS;
            document.getElementById('stat-cha').textContent = character.stats.CHA;
            
            // Populate equipment
            const equipmentList = document.getElementById('char-equipment');
            equipmentList.innerHTML = '';
            character.inventory.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                equipmentList.appendChild(li);
            });
        }

        document.getElementById('close-sheet').addEventListener('click', () => {
            document.getElementById('character-sheet').style.display = 'none';
        });

        // Dungeon interaction system
        function showInteractionOptions(cellType, position) {
            const optionsDiv = document.getElementById('interaction-options');
            optionsDiv.innerHTML = '';
            
            // Door interaction options
            if (cellType & this.DOORSPACE) {
                const doorType = generator.getDoorType(cellType);
                
                const header = document.createElement('h4');
                header.textContent = "Door Interaction";
                optionsDiv.appendChild(header);
                
                if (doorType === 'secret') {
                    const searchBtn = document.createElement('button');
                    searchBtn.textContent = "Search for Secret Door";
                    searchBtn.addEventListener('click', () => searchForSecretDoor(position));
                    optionsDiv.appendChild(searchBtn);
                } else {
                    if (doorType === 'lock') {
                        const pickBtn = document.createElement('button');
                        pickBtn.textContent = "Pick Lock";
                        pickBtn.addEventListener('click', () => pickLock(position));
                        optionsDiv.appendChild(pickBtn);
                    }
                    
                    const openBtn = document.createElement('button');
                    openBtn.textContent = doorType === 'portc' ? "Raise Portcullis" : "Open Door";
                    openBtn.addEventListener('click', () => openDoor(position));
                    optionsDiv.appendChild(openBtn);
                    
                    const forceBtn = document.createElement('button');
                    forceBtn.textContent = "Force Open";
                    forceBtn.addEventListener('click', () => forceDoor(position));
                    optionsDiv.appendChild(forceBtn);
                }
            }
            
            // Stair interaction
            if (cellType & this.STAIRS) {
                const header = document.createElement('h4');
                header.textContent = "Stairs";
                optionsDiv.appendChild(header);
                
                const descendBtn = document.createElement('button');
                descendBtn.textContent = "Descend Stairs";
                descendBtn.addEventListener('click', () => descendStairs(position));
                optionsDiv.appendChild(descendBtn);
            }
            
            // Show the interaction panel
            document.getElementById('dungeon-interaction').style.display = 'block';
        }

        function searchForSecretDoor(position) {
            socket.send(JSON.stringify({
                type: "player_action",
                player_id: playerId,
                command: `search for secret doors at position ${position[0]},${position[1]}`
            }));
        }

        function pickLock(position) {
            socket.send(JSON.stringify({
                type: "player_action",
                player_id: playerId,
                command: `attempt to pick lock at position ${position[0]},${position[1]}`
            }));
        }

        function openDoor(position) {
            socket.send(JSON.stringify({
                type: "player_action",
                player_id: playerId,
                command: `open door at position ${position[0]},${position[1]}`
            }));
        }

        function forceDoor(position) {
            socket.send(JSON.stringify({
                type: "player_action",
                player_id: playerId,
                command: `force open door at position ${position[0]},${position[1]}`
            }));
        }

        function descendStairs(position) {
            socket.send(JSON.stringify({
                type: "player_action",
                player_id: playerId,
                command: `descend stairs at position ${position[0]},${position[1]}`
            }));
        }

        // Add to canvas click handler
        canvas.addEventListener('click', (event) => {
            if (!playerId) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const cellSize = generator.opts.cell_size;
            const col = Math.floor(x / cellSize);
            const row = Math.floor(y / cellSize);
            
            // Get cell type at clicked position
            const cellType = generator.cell[row][col];
            
            // Show interaction options based on cell type
            showInteractionOptions(cellType, [row, col]);
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('dungeonCanvas');
            let generator;
            const roomDescription = document.getElementById('room-description');

            // Toggle panel visibility
            document.getElementById('togglePanel').addEventListener('click', function() {
                const controls = document.querySelector('.controls');
                controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
            });

            // New Random Seed button
            document.getElementById('newSeedBtn').addEventListener('click', function() {
                const newSeed = Math.floor(Math.random() * 100000);
                document.getElementById('seed').value = newSeed;
                generateDungeon();
            });

            // Update dead end removal value display
            const deadEndRemoval = document.getElementById('deadEndRemoval');
            const deadEndValue = document.getElementById('deadEndValue');
            deadEndRemoval.addEventListener('input', function() {
                deadEndValue.textContent = this.value + '%';
            });
            function generateDungeon() {
                const baseCellSize = parseInt(document.getElementById('cellSize').value);
                const params = {
                    seed: parseInt(document.getElementById('seed').value),
                    n_rows: parseInt(document.getElementById('rows').value),
                    n_cols: parseInt(document.getElementById('cols').value),
                    cell_size: baseCellSize * 2,
                    room_min: parseInt(document.getElementById('roomMin').value),
                    room_max: parseInt(document.getElementById('roomMax').value),
                    room_layout: document.getElementById('roomLayout').value,
                    corridor_layout: document.getElementById('corridorLayout').value,
                    remove_deadends: parseInt(document.getElementById('deadEndRemoval').value),
                    dungeon_layout: document.getElementById('dungeonLayout').value,
                    add_stairs: parseInt(document.getElementById('stairs').value)
                };

                generator = new DungeonGenerator(params);
                generator.createDungeon();
                generator.renderToCanvas(canvas);
                
                // Generate simple room description
                const themes = ["ancient", "damp", "mysterious", "forgotten", "crumbling"];
                const types = ["chamber", "hall", "crypt", "gallery", "vault"];
                const features = ["covered in moss", "lit by torches", "filled with echoes", "decorated with strange symbols"];
                
                const theme = themes[Math.floor(Math.random() * themes.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                const feature = features[Math.floor(Math.random() * features.length)];
                
                roomDescription.textContent = `You enter a ${theme} ${type} ${feature}. The air is thick with the scent of earth and time.`;
            }

            // Generate button event
            document.getElementById('generateBtn').addEventListener('click', generateDungeon);


            
            // Randomize parameters button
            document.getElementById('randomizeBtn').addEventListener('click', () => {
                document.getElementById('seed').value = Math.floor(Math.random() * 100000);
                document.getElementById('rows').value = 5 + Math.floor(Math.random() * 30) * 2;
                document.getElementById('cols').value = 5 + Math.floor(Math.random() * 30) * 2;
                document.getElementById('cellSize').value = 10 + Math.floor(Math.random() * 15);
                document.getElementById('roomMin').value = 3 + Math.floor(Math.random() * 5);
                document.getElementById('roomMax').value = 7 + Math.floor(Math.random() * 8);

                // Randomize corridor settings
                const corridorLayouts = ['Labyrinth', 'Bent', 'Straight'];
                document.getElementById('corridorLayout').value = corridorLayouts[Math.floor(Math.random() * 3)];
                const deadEndValue = Math.floor(Math.random() * 101);
                document.getElementById('deadEndRemoval').value = deadEndValue;
                document.getElementById('deadEndValue').textContent = deadEndValue + '%';
                
                // Randomize dungeon layout
                const dungeonLayouts = ['None', 'Box', 'Cross', 'Round'];
                document.getElementById('dungeonLayout').value = dungeonLayouts[Math.floor(Math.random() * 4)];
                document.getElementById('stairs').value = Math.floor(Math.random() * 5);
                
                generateDungeon();
            });

            // Generate initial dungeon
            generateDungeon();
        });

        function updateGameState(state) {
            if (!state.success) {
                console.error("Error:", state.data.message);
                return;
            }

            // Update characters
            generator.characters = state.data.characters;
            
            // Render the dungeon with characters
            renderCharacters();
            
            // Update room description
            const roomInfo = document.getElementById('room-description');
            roomInfo.textContent = state.data.message;
            
            // Update character stats
            updateCharacterStats(state.data.characters);
        }

        function renderCharacters() {
            const canvas = document.getElementById('dungeonCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const cellSize = generator.opts.cell_size;
            
            // Redraw the dungeon first
            generator.renderToCanvas(canvas);
            
            // Draw each character
            for (const charId in generator.characters) {
                const char = generator.characters[charId];
                const x = char.position[1] * cellSize;
                const y = char.position[0] * cellSize;
                
                // Character circle
                ctx.beginPath();
                ctx.arc(x + cellSize/2, y + cellSize/2, cellSize/3, 0, Math.PI * 2);
                ctx.fillStyle = char.player_controlled ? '#00FF00' : '#FF0000';
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Character name
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(char.name, x + cellSize/2, y - 5);
            }
        }

        function updateCharacterStats(characters) {
            const partyList = document.getElementById('party-list');
            if (!partyList) return;
            
            partyList.innerHTML = '';
            
            for (const charId in characters) {
                const char = characters[charId];
                const charElement = document.createElement('div');
                charElement.className = 'character-card';
                charElement.innerHTML = `
                    <strong>${char.name}</strong>
                    <div>${char.race} ${char.class_}</div>
                    <div>HP: ${char.hit_points}/${char._calculate_max_hp ? char._calculate_max_hp() : 'N/A'}</div>
                    <div>Position: ${char.position[0]}, ${char.position[1]}</div>
                `;
                partyList.appendChild(charElement);
            }
        }

        // Add character button handler
        document.getElementById('add-character')?.addEventListener('click', () => {
            const name = prompt('Character name:');
            if (name) {
                const race = prompt('Race:', 'Human');
                const class_ = prompt('Class:', 'Fighter');
                
                socket.send(JSON.stringify({
                    type: 'character_create',
                    data: { 
                        name: name,
                        race: race || 'Human',
                        class_: class_ || 'Fighter'
                    }
                }));
            }
        });
    </script>
</body>
</html>